<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Off-Check</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Sortable/1.15.0/Sortable.min.js"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              available: "#10B981",
              unavailable: "#EF4444",
              neutral: "#9CA3AF",
            },
          },
        },
      };
    </script>
    <style>
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 30px;
        height: 30px;
        animation: spin 1s linear infinite;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      /* Slide Animations */
      .slide-in-right {
        animation: slideInRight 0.3s ease-out forwards;
      }
      .slide-in-left {
        animation: slideInLeft 0.3s ease-out forwards;
      }
      @keyframes slideInRight {
        from {
          transform: translateX(20px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }
      @keyframes slideInLeft {
        from {
          transform: translateX(-20px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      /* Sticky Header & Column Styles */
      .sticky-header-row th {
        position: sticky;
        top: 0;
        z-index: 20;
        /* Ensure background covers scrolling content */
        background-color: #f5f5f5;
        /* Add shadow for depth when scrolling */
        box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
      }

      /* Sticky Left Column (Name) */
      .sticky-left-col {
        position: sticky;
        left: 0;
        z-index: 10;
        /* Background is set inline or via utility classes, but ensures stacking context */
      }

      /* Top-Left Corner (Intersection) */
      /* Must be higher than both row header (20) and col header (10) */
      .sticky-header-row .sticky-left-col {
        z-index: 30 !important;
      }
    </style>
  </head>
  <body class="bg-gray-100 min-h-screen flex flex-col">
    <!-- Login View -->
    <div id="login-view" class="flex-grow flex items-center justify-center p-4">
      <!-- ... (Existing Login Form) ... -->
      <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
        <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">
          Off-Check Login
        </h1>
        <form id="login-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700">Name</label>
            <input
              type="text"
              id="username"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
              required
              placeholder="e.g., Cathy"
            />
          </div>
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >Password</label
            >
            <input
              type="password"
              id="password"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
              required
              placeholder="e.g., 1234"
            />
          </div>
          <div id="login-error" class="text-red-500 text-sm hidden"></div>
          <button
            type="submit"
            class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700 transition"
          >
            Login
          </button>
        </form>
        <div class="mt-4 text-xs text-gray-500 text-center">
          * Local Test Accounts: Cathy, staff / 1234
        </div>
      </div>
    </div>

    <!-- Change Password View (New) -->
    <div
      id="change-password-view"
      class="hidden flex-grow flex items-center justify-center p-4"
    >
      <div class="bg-white p-8 rounded-lg shadow-md w-full max-w-sm">
        <h1 class="text-2xl font-bold mb-6 text-center text-gray-800">
          Change Password
        </h1>
        <p class="mb-4 text-sm text-gray-600">
          For security, you must change your password on first login (or if it's
          default).
        </p>
        <form id="change-password-form" class="space-y-4">
          <div>
            <label class="block text-sm font-medium text-gray-700"
              >New Password</label
            >
            <input
              type="password"
              id="new-password"
              class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
              required
              placeholder="4-8 digits (0-9)"
              pattern="^[0-9]{4,8}$"
              title="Password must be 4-8 digits"
            />
          </div>
          <div id="cp-error" class="text-red-500 text-sm hidden"></div>
          <button
            type="submit"
            class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700 transition"
          >
            Update Password
          </button>
        </form>
      </div>
    </div>

    <!-- Main App View -->
    <div id="main-view" class="hidden flex-col h-screen">
      <!-- Navigation Header -->
      <header
        class="bg-white shadow px-4 py-3 flex justify-between items-center sticky top-0 z-30"
      >
        <h1 class="font-bold text-lg text-gray-800">Off-Check</h1>
        <div class="flex items-center space-x-2">
          <span
            id="user-display"
            class="text-sm text-gray-600 font-medium"
          ></span>
          <button
            onclick="logout()"
            class="text-xs bg-gray-200 px-2 py-1 rounded hover:bg-gray-300"
          >
            Logout
          </button>
        </div>
      </header>

      <!-- Admin Tab Navigation (Visible only to Admin) -->
      <div
        id="admin-tabs"
        class="hidden px-4 pt-3 pb-1 w-full bg-white shrink-0"
      >
        <div class="bg-gray-100 p-1 rounded-lg flex w-full">
          <button
            onclick="switchTab('personal')"
            id="tab-personal"
            class="flex-1 py-1.5 rounded-md text-sm font-medium transition-all duration-200 text-gray-500 hover:text-gray-700"
          >
            My Shift
          </button>
          <button
            onclick="switchTab('team')"
            id="tab-team"
            class="flex-1 py-1.5 rounded-md text-sm font-medium transition-all duration-200 text-gray-500 hover:text-gray-700"
          >
            Team
          </button>
        </div>
      </div>

      <!-- Team Sub-Tabs (Visible only when Team tab is active) -->
      <div
        id="team-sub-tabs"
        class="hidden bg-white border-b shrink-0 flex w-full"
      >
        <button
          onclick="switchTeamSubTab('dashboard')"
          id="subtab-dashboard"
          class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 flex items-center justify-center transition"
        >
          Dashboard
        </button>
        <button
          onclick="switchTeamSubTab('staff-manage')"
          id="subtab-staff-manage"
          class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 flex items-center justify-center transition"
        >
          Manage Staff
        </button>
      </div>

      <!-- Staff Tab Navigation (Visible only to Staff) -->
      <div
        id="staff-tabs"
        class="hidden bg-white border-b shrink-0 flex w-full"
      >
        <button
          onclick="switchStaffTab('weekly')"
          id="tab-staff-weekly"
          class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 flex items-center justify-center transition"
        >
          Weekly
        </button>
        <button
          onclick="switchStaffTab('monthly')"
          id="tab-staff-monthly"
          class="flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 flex items-center justify-center transition"
        >
          Monthly
        </button>
      </div>

      <!-- Weekly Controls (Personal View Only) -->
      <div
        id="week-controls"
        class="bg-white border-b px-4 py-3 flex justify-between items-center sticky top-0 z-10"
      >
        <button
          id="btn-back-to-month"
          onclick="switchStaffTab('monthly')"
          class="hidden mr-2 p-2 rounded-full hover:bg-gray-100 text-gray-600"
          title="Back to Month"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M10 19l-7-7m0 0l7-7m-7 7h18"
            ></path>
          </svg>
        </button>
        <button
          onclick="changeWeek(-1)"
          class="p-2 rounded-full hover:bg-gray-100 text-gray-600"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M15 19l-7-7 7-7"
            ></path>
          </svg>
        </button>
        <div class="text-center">
          <div id="week-range" class="font-bold text-lg"></div>
          <div id="week-status" class="text-xs text-gray-500"></div>
        </div>
        <button
          onclick="changeWeek(1)"
          class="p-2 rounded-full hover:bg-gray-100 text-gray-600"
        >
          <svg
            class="w-6 h-6"
            fill="none"
            stroke="currentColor"
            viewBox="0 0 24 24"
          >
            <path
              stroke-linecap="round"
              stroke-linejoin="round"
              stroke-width="2"
              d="M9 5l7 7-7 7"
            ></path>
          </svg>
        </button>
      </div>

      <!-- Schedule Grid (Personal - Weekly) -->
      <div
        id="personal-view"
        class="flex-grow overflow-y-auto p-4 max-w-2xl mx-auto w-full"
      >
        <div id="loader" class="hidden flex justify-center py-4">
          <div class="loader"></div>
        </div>

        <div
          id="schedule-grid"
          class="flex flex-col gap-4 pb-20 max-w-2xl mx-auto"
        >
          <!-- Date cards generated here -->
        </div>
      </div>

      <!-- Monthly View (Staff Only) -->
      <div
        id="monthly-view"
        class="hidden flex-grow flex flex-col overflow-hidden w-full"
      >
        <!-- Monthly Controls -->
        <div
          class="bg-white border-b px-4 py-3 flex justify-between items-center shrink-0 sticky-top-bar"
        >
          <button
            onclick="changeMonth(-1)"
            class="p-2 rounded-full hover:bg-gray-100 text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              ></path>
            </svg>
          </button>
          <div class="text-center">
            <div id="monthly-range" class="font-bold text-lg"></div>
          </div>
          <button
            onclick="changeMonth(1)"
            class="p-2 rounded-full hover:bg-gray-100 text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Monthly Calendar Grid -->
        <div class="flex-grow overflow-y-auto p-2">
          <div class="bg-white shadow rounded-lg overflow-hidden">
            <!-- Days Header (Mon-Sun) -->
            <div class="grid grid-cols-7 border-b border-gray-200 bg-gray-50">
              <div class="py-2 text-center text-xs font-bold text-gray-500">
                Mon
              </div>
              <div class="py-2 text-center text-xs font-bold text-gray-500">
                Tue
              </div>
              <div class="py-2 text-center text-xs font-bold text-gray-500">
                Wed
              </div>
              <div class="py-2 text-center text-xs font-bold text-gray-500">
                Thu
              </div>
              <div class="py-2 text-center text-xs font-bold text-gray-500">
                Fri
              </div>
              <div class="py-2 text-center text-xs font-bold text-blue-500">
                Sat
              </div>
              <div class="py-2 text-center text-xs font-bold text-red-500">
                Sun
              </div>
            </div>
            <!-- Calendar Body -->
            <div
              id="monthly-grid"
              class="grid grid-cols-7 divide-x divide-y divide-gray-200 border-b border-gray-200"
            >
              <!-- JS Inject -->
            </div>
          </div>
        </div>
      </div>

      <!-- Admin View (Dashboard) -->
      <div
        id="admin-view"
        class="hidden flex-grow flex flex-col overflow-hidden w-full"
      >
        <!-- ... existing admin content ... -->
        <div id="admin-loader" class="hidden flex justify-center py-4">
          <div class="loader"></div>
        </div>

        <!-- Dashboard Controls (Matches Personal View) -->
        <div
          class="bg-white border-b px-4 py-3 flex justify-between items-center shrink-0 sticky-top-bar"
        >
          <button
            onclick="changeWeek(-1)"
            class="p-2 rounded-full hover:bg-gray-100 text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M15 19l-7-7 7-7"
              ></path>
            </svg>
          </button>
          <div class="text-center">
            <div id="admin-week-range" class="font-bold text-lg"></div>
            <div
              id="admin-week-status"
              class="text-xs text-gray-500 font-medium"
            ></div>
          </div>
          <button
            onclick="changeWeek(1)"
            class="p-2 rounded-full hover:bg-gray-100 text-gray-600"
          >
            <svg
              class="w-6 h-6"
              fill="none"
              stroke="currentColor"
              viewBox="0 0 24 24"
            >
              <path
                stroke-linecap="round"
                stroke-linejoin="round"
                stroke-width="2"
                d="M9 5l7 7-7 7"
              ></path>
            </svg>
          </button>
        </div>

        <!-- Unified Table View -->
        <div
          class="bg-white shadow rounded-lg overflow-hidden flex flex-col flex-grow border border-gray-200"
        >
          <div class="overflow-auto flex-grow relative custom-scrollbar">
            <table
              class="w-full table-fixed divide-y divide-gray-200 border-collapse"
            >
              <thead class="bg-[#F5F5F5] sticky-header-row shadow-sm">
                <tr>
                  <th
                    scope="col"
                    class="px-2 py-3 text-left text-xs md:text-base font-bold text-gray-500 uppercase tracking-wider sticky-left-col border-r border-b w-16 md:w-32"
                    style="background-color: #f5f5f5"
                  >
                    Name
                  </th>
                  <th id="admin-header-row" colspan="7" class="p-0 border-b">
                    <div
                      class="grid grid-cols-7 divide-x divide-gray-200 text-center w-full"
                    >
                      <!-- Headers Injected Here -->
                    </div>
                  </th>
                </tr>
              </thead>
              <tbody id="admin-tbody" class="bg-white divide-y divide-gray-200">
                <!-- Rows Injected Here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Manage Staff View (New) -->
      <div
        id="staff-manage-view"
        class="hidden flex-grow flex flex-col overflow-y-auto p-4 max-w-2xl mx-auto w-full"
      >
        <div class="bg-white p-6 rounded-lg shadow border border-gray-200">
          <h2 class="text-xl font-bold mb-4">Add New Staff</h2>
          <form id="add-staff-form" class="space-y-4">
            <div>
              <label class="block text-sm font-medium text-gray-700"
                >Staff Name</label
              >
              <input
                type="text"
                id="new-staff-name"
                class="mt-1 block w-full border border-gray-300 rounded-md shadow-sm p-2"
                required
                placeholder="Enter name"
              />
            </div>
            <button
              type="submit"
              class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700 transition"
            >
              Add Staff
            </button>
          </form>
          <p class="mt-4 text-sm text-gray-500">
            * Default password will be set to <strong>1234</strong>.<br />
            * Staff must change password on first login.
          </p>
        </div>

        <!-- Staff List (New) -->
        <div
          class="mt-8 bg-white px-4 py-4 rounded-lg shadow border border-gray-200"
        >
          <h3 class="text-lg font-bold mb-4">Current Staff</h3>
          <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
              <tbody
                id="staff-list-tbody"
                class="bg-white divide-y divide-gray-200"
              >
                <!-- Rows Injected Here -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Bottom Status Bar -->
      <div
        id="save-bar"
        class="hidden fixed bottom-0 w-full bg-white border-t p-4 shadow-lg flex justify-between items-center z-20"
      >
        <span class="text-sm text-gray-600">You have unsaved changes.</span>
        <button
          onclick="saveChanges()"
          class="bg-blue-600 text-white px-4 py-2 rounded shadow hover:bg-blue-700 font-bold"
          data-i18n="save_btn"
        >
          Save Changes
        </button>
      </div>
      <div
        id="status-bar"
        class="bg-gray-800 text-white text-xs py-2 px-4 text-center fixed bottom-0 w-full z-10"
        data-i18n="ready"
      >
        Ready
      </div>
    </div>

    <script>
      // --- Global State ---
      let currentUser = null;
      let currentRole = "staff"; // 'admin' or 'staff'
      let currentViewDate = new Date(); // Shared date state for simplicity, or split if needed
      let currentTab = "personal"; // 'personal' | 'team'
      let currentTeamSubTab = "dashboard"; // 'dashboard' | 'staff-manage'
      let currentStaffTab = "weekly"; // 'weekly' | 'monthly'
      const today = new Date();
      let availabilityData = {}; // Stores CURRENT USER's data ONLY
      let isSaving = false;
      let unsavedChanges = new Set(); // Track unsaved keys
      let lockedWeeks = new Set(); // Stores start dates (YYYY-MM-DD) of locked weeks

      const DAYS_EN = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];

      // --- SUPABASE CONFIGURATION ---
      // TODO: Enter your Supabase Project URL and Anon Key here!
      const SUPABASE_URL = "https://kvbvgioojmsfgycdxxam.supabase.co";
      const SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Imt2YnZnaW9vam1zZmd5Y2R4eGFtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg1OTY3MzksImV4cCI6MjA4NDE3MjczOX0.CzRPSe4-Z2-L2Mbfxua4LK-5yQXKySuOvX42YGqnkP8";

      // let supabase = null; // REMOVE duplicate declaration
      if (SUPABASE_URL && SUPABASE_ANON_KEY) {
        // window.supabase is loaded from CDN
        if (window.supabase) {
          supabase = window.supabase.createClient(
            SUPABASE_URL,
            SUPABASE_ANON_KEY
          );
        }
      }

      const IS_LOCAL = !supabase; // Fallback to LocalStorage if Supabase is not configured

      // --- Initialization ---
      window.onload = function () {
        if (!supabase && !localStorage.getItem("supabase_warning_shown")) {
          alert(
            "Supabase is not configured! Using LocalStorage mode.\nPlease edit index.html to add your SUPABASE_URL and KEY."
          );
          localStorage.setItem("supabase_warning_shown", "true");
        }

        // Initialize Local Users DB if empty (Fallback)
        if (IS_LOCAL) {
          // Migration: Rename 'admin' to 'Cathy' if exists
          try {
            let localUsers = JSON.parse(
              localStorage.getItem("local_users") || "null"
            );
            if (localUsers && localUsers["admin"]) {
              localUsers["Cathy"] = localUsers["admin"];
              delete localUsers["admin"];
              localStorage.setItem("local_users", JSON.stringify(localUsers));
            }

            let localMeta = JSON.parse(
              localStorage.getItem("local_users_meta") || "null"
            );
            if (localMeta && localMeta["admin"]) {
              localMeta["Cathy"] = localMeta["admin"];
              delete localMeta["admin"];
              localStorage.setItem(
                "local_users_meta",
                JSON.stringify(localMeta)
              );
            }
          } catch (e) {
            console.error("Migration failed", e);
          }

          if (!localStorage.getItem("local_users")) {
            const initialUsers = {
              Cathy: "1234",
              staff: "1234",
              staff1: "1234",
              staff2: "1234",
              staff3: "1234",
              staff4: "1234",
            };
            localStorage.setItem("local_users", JSON.stringify(initialUsers));
          }
        }

        // Check Session
        const savedUser = localStorage.getItem("shift_user");

        // Migration: Force Lock Current Week (One-time)
        if (IS_LOCAL && !localStorage.getItem("force_lock_current_applied")) {
          const currentWeekStr = formatDateISO(getMonday(new Date()));
          const stored = localStorage.getItem("locked_weeks");
          let weeks = stored ? JSON.parse(stored) : [];
          if (!weeks.includes(currentWeekStr)) {
            weeks.push(currentWeekStr);
            localStorage.setItem("locked_weeks", JSON.stringify(weeks));
          }
          localStorage.setItem("force_lock_current_applied", "true");
          // Update in-memory if needed (will be re-fetched in showMainView -> fetchLockedWeeks)
        }

        if (savedUser) {
          loginSuccess(savedUser);
        }
      };

      // --- Login/Logout ---
      document
        .getElementById("login-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;

          // Simple Loading Indicator
          const btn = e.target.querySelector("button");
          const originalText = btn.innerText;
          btn.innerText = "Logging in...";
          btn.disabled = true;

          if (IS_LOCAL) {
            setTimeout(() => {
              const localUsers = JSON.parse(
                localStorage.getItem("local_users") || "{}"
              );

              if (localUsers[username] && localUsers[username] === password) {
                // Check for Default Password
                if (password === "1234") {
                  // Force Password Change
                  showChangePasswordView(username);
                } else {
                  loginSuccess(username);
                }
              } else {
                showLoginError("Invalid password or user not found.");
              }
              btn.innerText = originalText;
              btn.disabled = false;
            }, 500);
          } else {
            // Supabase Login
            supabase
              .from("app_users")
              .select("*")
              .eq("username", username)
              .eq("password", password)
              .single()
              .then(({ data, error }) => {
                if (error || !data) {
                  showLoginError("Invalid password or user not found.");
                } else {
                  if (data.is_default_password) {
                    showChangePasswordView(data.username);
                  } else {
                    loginSuccess(data.username);
                  }
                }
                btn.innerText = originalText;
                btn.disabled = false;
              });
          }
        });

      function showChangePasswordView(username) {
        currentUser = username; // Temporary set for change password context
        document.getElementById("login-view").classList.add("hidden");
        document
          .getElementById("change-password-view")
          .classList.remove("hidden");
      }

      document
        .getElementById("change-password-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const newPassword = document.getElementById("new-password").value;

          // Regex Check handled by HTML5 pattern, but double check
          if (!/^[0-9]{4,8}$/.test(newPassword)) {
            document.getElementById("cp-error").innerText =
              "Password must be 4-8 digits.";
            document.getElementById("cp-error").classList.remove("hidden");
            return;
          }

          if (IS_LOCAL) {
            const localUsers = JSON.parse(
              localStorage.getItem("local_users") || "{}"
            );
            if (localUsers[currentUser]) {
              localUsers[currentUser] = newPassword;
              localStorage.setItem("local_users", JSON.stringify(localUsers));
              alert("Password changed successfully.");
              loginSuccess(currentUser);
              document
                .getElementById("change-password-view")
                .classList.add("hidden");
            }
          } else {
            // Supabase Change Password
            supabase
              .from("app_users")
              .update({ password: newPassword, is_default_password: false })
              .eq("username", currentUser)
              .then(({ error }) => {
                if (!error) {
                  alert("Password changed successfully.");
                  loginSuccess(currentUser);
                  document
                    .getElementById("change-password-view")
                    .classList.add("hidden");
                } else {
                  document.getElementById("cp-error").innerText = error.message;
                  document
                    .getElementById("cp-error")
                    .classList.remove("hidden");
                }
              });
          }
        });

      // Add Staff Logic
      document
        .getElementById("add-staff-form")
        .addEventListener("submit", function (e) {
          e.preventDefault();
          const newName = document
            .getElementById("new-staff-name")
            .value.trim();
          if (!newName) return;

          if (IS_LOCAL) {
            const localUsers = JSON.parse(
              localStorage.getItem("local_users") || "{}"
            );
            if (localUsers[newName]) {
              alert("User already exists!");
              return;
            }
            localUsers[newName] = "1234";
            localStorage.setItem("local_users", JSON.stringify(localUsers));

            // Init Meta for Local
            const meta = JSON.parse(
              localStorage.getItem("local_users_meta") || "{}"
            );
            meta[newName] = { type: "Casual", order: 999 };
            localStorage.setItem("local_users_meta", JSON.stringify(meta));

            alert(`Staff '${newName}' added with default password '1234'.`);
            document.getElementById("new-staff-name").value = "";
            fetchStaffList(); // Refresh list
          } else {
            // Supabase Add User
            supabase
              .from("app_users")
              .insert([
                {
                  username: newName,
                  password: "1234",
                  role: "staff",
                  is_default_password: true,
                },
              ])
              .then(({ error }) => {
                if (!error) {
                  alert(
                    `Staff '${newName}' added with default password '1234'.`
                  );
                  document.getElementById("new-staff-name").value = "";
                  fetchStaffList();
                } else {
                  alert("Error: " + error.message);
                }
              });
          }
        });

      function showLoginError(msg) {
        const el = document.getElementById("login-error");
        el.innerText = msg;
        el.classList.remove("hidden");
      }

      function loginSuccess(username) {
        currentUser = username;
        currentRole = username === "Cathy" ? "admin" : "staff";
        localStorage.setItem("shift_user", username);

        // Reset State
        availabilityData = {};
        unsavedChanges.clear();
        updateSaveBar();

        // Requirement: Default to Next Week for Staff
        if (currentRole !== "admin") {
          const nextWeek = new Date();
          nextWeek.setDate(nextWeek.getDate() + 7);
          currentViewDate = getMonday(nextWeek);
          // Simulate URL change
          window.location.hash = "/next-week-schedule";
        } else {
          currentViewDate = getMonday(new Date());
        }

        showMainView();
      }

      function logout() {
        currentUser = null;
        currentRole = "staff";
        availabilityData = {};
        localStorage.removeItem("shift_user");
        sessionStorage.removeItem("thursday_banner_dismissed"); // Reset banner dismissal on logout

        document.getElementById("main-view").classList.add("hidden");
        document.getElementById("login-view").classList.remove("hidden");
        document.getElementById("username").value = "";
        document.getElementById("password").value = "";
      }

      // --- View Management ---
      function showMainView() {
        document.getElementById("login-view").classList.add("hidden");
        document.getElementById("main-view").classList.remove("hidden");
        document.getElementById("main-view").classList.add("flex");
        document.getElementById("user-display").innerText = currentUser;

        // Reset Views
        document.getElementById("admin-tabs").classList.add("hidden");
        document.getElementById("staff-tabs").classList.add("hidden");
        document.getElementById("personal-view").classList.add("hidden");
        document.getElementById("monthly-view").classList.add("hidden");
        document.getElementById("admin-view").classList.add("hidden");
        document.getElementById("week-controls").classList.add("hidden");

        // Fetch Locked Weeks (Async)
        fetchLockedWeeks();

        if (currentRole === "admin") {
          document.getElementById("admin-tabs").classList.remove("hidden");
          switchTab("personal"); // Default to Personal View (My Shift)
        } else {
          // Staff only sees Personal View
          document.getElementById("staff-tabs").classList.remove("hidden");
          switchStaffTab("weekly");
          updateNavigationState();
        }
      }

      function fetchLockedWeeks() {
        if (IS_LOCAL) {
          const stored = localStorage.getItem("locked_weeks");
          if (stored) {
            lockedWeeks = new Set(JSON.parse(stored));
          } else {
            // Default: Lock Current Week as per requirement
            const currentWeekStr = formatDateISO(getMonday(today));
            lockedWeeks = new Set([currentWeekStr]);
            localStorage.setItem(
              "locked_weeks",
              JSON.stringify([...lockedWeeks])
            );
          }
        } else {
          // Supabase Fetch Locked Weeks
          supabase
            .from("app_settings")
            .select("value")
            .eq("key", "locked_weeks")
            .single()
            .then(({ data, error }) => {
              if (data && data.value) {
                lockedWeeks = new Set(data.value);
              } else {
                lockedWeeks = new Set();
              }
              // Re-render if visible
              if (
                !document
                  .getElementById("personal-view")
                  .classList.contains("hidden")
              ) {
                renderWeek();
              }
              if (
                !document
                  .getElementById("admin-view")
                  .classList.contains("hidden") &&
                currentTeamSubTab === "dashboard"
              ) {
                renderAdminView();
              }
            });
        }
      }

      function toggleWeekLock(isLocked) {
        const weekStartStr = formatDateISO(getMonday(currentViewDate));

        // Optimistic UI Update
        if (isLocked) lockedWeeks.add(weekStartStr);
        else lockedWeeks.delete(weekStartStr);

        renderAdminView(); // Update Button State

        if (IS_LOCAL) {
          localStorage.setItem(
            "locked_weeks",
            JSON.stringify([...lockedWeeks])
          );
          showToast(isLocked ? "Week Locked" : "Week Unlocked");
        } else {
          // Supabase Toggle Lock
          supabase
            .from("app_settings")
            .upsert({ key: "locked_weeks", value: [...lockedWeeks] })
            .then(({ error }) => {
              if (error) {
                handleError(error);
                // Revert
                if (isLocked) lockedWeeks.delete(weekStartStr);
                else lockedWeeks.add(weekStartStr);
                renderAdminView();
              } else {
                showToast(isLocked ? "Week Locked" : "Week Unlocked");
              }
            });
        }
      }

      function switchTab(tabName) {
        currentTab = tabName;
        const personalView = document.getElementById("personal-view");
        const adminView = document.getElementById("admin-view");
        const staffManageView = document.getElementById("staff-manage-view");
        const weekControls = document.getElementById("week-controls");
        const teamSubTabs = document.getElementById("team-sub-tabs");
        const staffTabs = document.getElementById("staff-tabs");

        const tabPersonal = document.getElementById("tab-personal");
        const tabTeam = document.getElementById("tab-team");

        // Segmented Control Styles (Main Tabs)
        const baseClass =
          "flex-1 py-1.5 rounded-md text-sm font-medium transition-all duration-200 text-gray-500 hover:text-gray-700";
        const activeClass =
          "flex-1 py-1.5 rounded-md text-sm font-medium transition-all duration-200 bg-white shadow text-gray-900";

        // Reset Styles
        tabPersonal.className = baseClass;
        tabTeam.className = baseClass;

        // Hide All Views First
        personalView.classList.add("hidden");
        adminView.classList.add("hidden");
        staffManageView.classList.add("hidden");
        weekControls.classList.add("hidden");
        teamSubTabs.classList.add("hidden");
        staffTabs.classList.add("hidden"); // Ensure staff tabs are hidden for admin personal view if needed, but we reuse staff tabs for personal view
        document.getElementById("status-bar").classList.add("hidden");
        document.getElementById("monthly-view").classList.add("hidden");

        if (tabName === "personal") {
          // Admin Personal View: Reuses Staff View Components
          tabPersonal.className = activeClass;

          // Show Staff Tabs (Weekly/Monthly) for Admin Personal View
          staffTabs.classList.remove("hidden");

          // Reset to Weekly view by default when switching to Personal tab
          switchStaffTab("weekly");
        } else if (tabName === "team") {
          tabTeam.className = activeClass;
          teamSubTabs.classList.remove("hidden");
          switchTeamSubTab(currentTeamSubTab);
        }
      }

      function switchTeamSubTab(subTabName) {
        currentTeamSubTab = subTabName;

        const adminView = document.getElementById("admin-view");
        const staffManageView = document.getElementById("staff-manage-view");
        const weekControls = document.getElementById("week-controls");

        const subtabDashboard = document.getElementById("subtab-dashboard");
        const subtabStaffManage = document.getElementById(
          "subtab-staff-manage"
        );

        // Underline Tab Styles (Sub-tabs - Matching Staff Tabs)
        const baseClass =
          "flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition flex items-center justify-center";
        const activeClass =
          "flex-1 py-3 text-sm font-bold border-b-2 border-blue-600 text-blue-600 transition flex items-center justify-center";

        subtabDashboard.className = baseClass;
        subtabStaffManage.className = baseClass;

        adminView.classList.add("hidden");
        staffManageView.classList.add("hidden");
        weekControls.classList.add("hidden");

        if (subTabName === "dashboard") {
          subtabDashboard.className = activeClass;
          adminView.classList.remove("hidden");
          renderAdminView();
          fetchAdminData();
        } else if (subTabName === "staff-manage") {
          subtabStaffManage.className = activeClass;
          staffManageView.classList.remove("hidden");
          fetchStaffList();
        }
      }

      function switchStaffTab(tabName, isFromMonthly = false) {
        currentStaffTab = tabName;
        const personalView = document.getElementById("personal-view");
        const monthlyView = document.getElementById("monthly-view");
        const weekControls = document.getElementById("week-controls");

        const tabWeekly = document.getElementById("tab-staff-weekly");
        const tabMonthly = document.getElementById("tab-staff-monthly");
        const btnBack = document.getElementById("btn-back-to-month");

        const baseClass =
          "flex-1 py-3 text-sm font-medium border-b-2 border-transparent text-gray-500 hover:text-gray-700 transition flex items-center justify-center";
        const activeClass =
          "flex-1 py-3 text-sm font-bold border-b-2 border-blue-600 text-blue-600 transition flex items-center justify-center";

        // Reset Styles
        tabWeekly.className = baseClass;
        tabMonthly.className = baseClass;

        // Remove existing animation classes
        personalView.classList.remove("slide-in-right", "slide-in-left");
        monthlyView.classList.remove("slide-in-right", "slide-in-left");

        if (tabName === "weekly") {
          personalView.classList.remove("hidden");
          weekControls.classList.remove("hidden");
          monthlyView.classList.add("hidden");

          // Animation
          personalView.classList.add("slide-in-right");

          // Show Status Bar in Personal View
          document.getElementById("status-bar").classList.remove("hidden");

          tabWeekly.className = activeClass;

          // If coming from monthly click, show back button
          if (isFromMonthly) {
            btnBack.classList.remove("hidden");
          } else {
            btnBack.classList.add("hidden");
            // Default to Next Week for Staff when switching tabs manually
            const nextWeek = new Date();
            nextWeek.setDate(nextWeek.getDate() + 7);
            currentViewDate = getMonday(nextWeek);
          }

          renderWeek();
          fetchData();
        } else {
          personalView.classList.add("hidden");
          weekControls.classList.add("hidden");
          monthlyView.classList.remove("hidden");

          // Animation
          monthlyView.classList.add("slide-in-left");

          // Hide Status Bar in Monthly View (Read-only)
          document.getElementById("status-bar").classList.add("hidden");

          tabMonthly.className = activeClass;

          renderMonthlyView();
          fetchMonthlyData();
        }
      }

      function changeWeek(offset) {
        const newDate = new Date(currentViewDate);
        newDate.setDate(newDate.getDate() + offset * 7);

        // Limit Check (Approx 3 months)
        const diffTime = Math.abs(newDate - today);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        // Increased limit to 4 months to accommodate "Next Week + 2 Months" + Buffer
        if (diffDays > 120) {
          showToast("Max 4 months range.");
          return;
        }

        currentViewDate = newDate;

        // Refresh Active View
        if (currentRole === "admin" && currentTab === "team") {
          if (currentTeamSubTab === "dashboard") {
            renderAdminView();
            fetchAdminData();
          }
        } else {
          renderWeek();
          fetchData();
        }
      }

      // --- Admin Dashboard Logic ---
      function renderAdminView() {
        const startOfWeek = new Date(currentViewDate);
        const isReadOnly = checkReadOnly(startOfWeek);
        const statusEl = document.getElementById("admin-week-status");
        const weekStr = formatDateISO(startOfWeek);
        const isLockedInDB = lockedWeeks.has(weekStr);

        // Update Status Badge
        if (isReadOnly) {
          statusEl.innerText = "Confirmed (Locked)";
          statusEl.className =
            "text-[10px] bg-green-100 text-green-800 px-2 py-0.5 rounded-full inline-block mt-1";
        } else {
          statusEl.innerText = "Draft (Open)";
          statusEl.className =
            "text-[10px] bg-yellow-100 text-yellow-800 px-2 py-0.5 rounded-full inline-block mt-1";
        }

        // Add/Update Lock Button
        // We inject it into the header-right area or create a controls area
        // Currently there is no explicit controls area in Admin Header.
        // We can append it to the "admin-week-range" container or replace the status badge container?
        // Let's create a dedicated control below the range.

        let controlsContainer = document.getElementById(
          "admin-controls-container"
        );
        if (!controlsContainer) {
          // Create if not exists (Hack: Insert after week-range div)
          const weekRangeDiv =
            document.getElementById("admin-week-range").parentNode;
          controlsContainer = document.createElement("div");
          controlsContainer.id = "admin-controls-container";
          controlsContainer.className = "flex items-center gap-2 mt-2";
          weekRangeDiv.appendChild(controlsContainer);
        }

        controlsContainer.innerHTML = `
            <button onclick="toggleWeekLock(${!isLockedInDB})" class="text-xs px-3 py-1 rounded shadow transition-colors ${
          isLockedInDB
            ? "bg-red-100 text-red-700 hover:bg-red-200"
            : "bg-green-100 text-green-700 hover:bg-green-200"
        }">
                ${isLockedInDB ? "Unlock Week" : "Lock Week"}
            </button>
        `;

        const headerContainer = document.querySelector(
          "#admin-header-row > div"
        );
        headerContainer.innerHTML = "";

        const endOfWeek = new Date(startOfWeek.getTime() + 6 * 86400000);
        document.getElementById(
          "admin-week-range"
        ).innerText = `${formatDateShort(startOfWeek)} ~ ${formatDateShort(
          endOfWeek
        )}`;

        // ... rest of header loop
        for (let i = 0; i < 7; i++) {
          const d = new Date(startOfWeek);
          d.setDate(d.getDate() + i);
          const dayName = DAYS_EN[d.getDay()];
          const isToday = formatDateISO(d) === formatDateISO(today);

          const col = document.createElement("div");
          col.className = `py-1 md:py-2 text-[10px] md:text-base font-bold uppercase tracking-wider ${
            isToday ? "bg-blue-50 text-blue-600" : "text-gray-500"
          }`;
          col.innerHTML = `${dayName}<br>${d.getDate()}`;
          headerContainer.appendChild(col);
        }
      }

      function fetchAdminData() {
        const start = formatDateISO(currentViewDate);
        const end = new Date(currentViewDate);
        end.setDate(end.getDate() + 6);
        const endStr = formatDateISO(end);

        document.getElementById("admin-loader").classList.remove("hidden");
        const tbody = document.getElementById("admin-tbody");
        tbody.innerHTML = "";

        if (IS_LOCAL) {
          setTimeout(() => {
            const users = [
              "Cathy",
              "staff",
              "staff1",
              "staff2",
              "staff3",
              "staff4",
            ];
            const shifts = [];
            for (let i = 0; i < localStorage.length; i++) {
              const key = localStorage.key(i);
              if (key.startsWith("shifts_")) {
                const uname = key.replace("shifts_", "");
                if (!users.includes(uname)) users.push(uname);
                const data = JSON.parse(localStorage.getItem(key));
                for (const k in data) {
                  const [d, t] = k.split("_");
                  shifts.push({
                    name: uname,
                    date: d,
                    type: t,
                    status: data[k],
                  });
                }
              }
            }
            window.adminDataCache = { users, shifts };
            renderAdminTable(users, shifts);
            document.getElementById("admin-loader").classList.add("hidden");
          }, 300);
        } else {
          // Supabase Admin Data Fetch
          Promise.all([
            supabase.from("app_users").select("*"),
            supabase
              .from("shifts")
              .select("*")
              .gte("date", start)
              .lte("date", endStr),
          ])
            .then(([resUsers, resShifts]) => {
              if (resUsers.error) throw resUsers.error;
              if (resShifts.error) throw resShifts.error;

              // Filter out 'Cathy' from display list if needed, or include all
              // Current logic includes all found in shifts + hardcoded list.
              // Let's use the DB users list.
              const users = resUsers.data
                .filter((u) => u.username !== "Cathy") // Usually Admin is hidden from grid or shown? Logic says "if !users.includes(uname)"
                .sort((a, b) => (a.order_index || 999) - (b.order_index || 999))
                .map((u) => u.username);

              // Add Admin to list if they have shifts?
              // Original logic: "Cathy" was in the list.
              users.unshift("Cathy");

              const shifts = resShifts.data.map((s) => ({
                name: s.username,
                date: s.date,
                type: s.type,
                status: s.status,
              }));

              window.adminDataCache = { users, shifts };
              renderAdminTable(users, shifts);
              document.getElementById("admin-loader").classList.add("hidden");
            })
            .catch(handleError);
        }
      }

      // --- Monthly View Logic ---
      function renderMonthlyView() {
        const grid = document.getElementById("monthly-grid");
        grid.innerHTML = "";

        const year = currentViewDate.getFullYear();
        const month = currentViewDate.getMonth();

        const monthNames = [
          "January",
          "February",
          "March",
          "April",
          "May",
          "June",
          "July",
          "August",
          "September",
          "October",
          "November",
          "December",
        ];
        document.getElementById(
          "monthly-range"
        ).innerText = `${monthNames[month]} ${year}`;

        const firstDayOfMonth = new Date(year, month, 1);

        // Adjust for Mon-Sun week (Mon=0, Sun=6 for calc purposes)
        // Native getDay(): Sun=0, Mon=1...Sat=6
        // We need Mon=0, ..., Sun=6
        let startDay = firstDayOfMonth.getDay() - 1;
        if (startDay === -1) startDay = 6; // Sunday

        const startDate = new Date(firstDayOfMonth);
        startDate.setDate(startDate.getDate() - startDay);

        // Fixed 5 weeks * 7 days = 35 cells
        for (let i = 0; i < 35; i++) {
          const d = new Date(startDate);
          d.setDate(d.getDate() + i);
          const dateStr = formatDateISO(d);
          const isToday = formatDateISO(d) === formatDateISO(today);
          const isCurrentMonth = d.getMonth() === month;

          // Hide cells if not current month to keep focus, OR keep them grayed out
          // Requirement: "Show one month at a time".
          // Usually we show grayed out previous/next month days to fill the grid.
          // Let's keep grayed out for structure.

          const cell = document.createElement("div");
          cell.className = `min-h-[100px] flex flex-col relative border-b border-r border-gray-100 ${
            isCurrentMonth ? "bg-white" : "bg-gray-50 text-gray-300"
          } ${
            isToday ? "bg-blue-50" : ""
          } hover:bg-gray-100 cursor-pointer transition-colors`;

          cell.onclick = () => {
            // Access Control: Block navigation to past dates
            const minDate = new Date(today.getFullYear(), today.getMonth(), 1);
            if (currentRole !== "admin" && d < minDate) {
              showToast("Cannot access past dates.");
              return;
            }
            // Navigate to Weekly View for this date
            currentViewDate = getMonday(d);
            switchStaffTab("weekly", true);
          };

          // Date Label
          const dateLabel = document.createElement("div");
          // Mon-Sun indexing: 0-4=Mon-Fri, 5=Sat, 6=Sun
          // d.getDay(): 0=Sun, 6=Sat
          const dayIndex = d.getDay();

          dateLabel.className = `text-xs font-bold p-1 ${
            dayIndex === 0
              ? "text-red-500" // Sun
              : dayIndex === 6
              ? "text-blue-500" // Sat
              : "text-gray-700"
          } ${!isCurrentMonth ? "opacity-50" : ""}`;

          dateLabel.innerText = d.getDate();
          cell.appendChild(dateLabel);

          // Grid Container for Lunch/Dinner (Matches Admin Style)
          const gridContainer = document.createElement("div");
          gridContainer.className = "flex flex-col flex-grow w-full";

          const lunchStatus = availabilityData[`${dateStr}_lunch`] || "none";
          const dinnerStatus = availabilityData[`${dateStr}_dinner`] || "none";

          // Lunch Slot (Top)
          const lunchDiv = document.createElement("div");
          lunchDiv.className =
            "flex-1 w-full flex items-center justify-center border-t border-b border-gray-100 min-h-[30px]";
          if (lunchStatus === "unavailable") {
            // If not current month, maybe hide or dim icons?
            // Let's dim them if not current month
            const opacityClass = isCurrentMonth ? "" : "opacity-30";
            lunchDiv.innerHTML = `<div class="w-6 h-6 ${opacityClass}">${createIconBadgeHtml(
              "unavailable"
            )}</div>`;
          }
          gridContainer.appendChild(lunchDiv);

          // Dinner Slot (Bottom)
          const dinnerDiv = document.createElement("div");
          dinnerDiv.className =
            "flex-1 w-full flex items-center justify-center min-h-[30px]";
          if (dinnerStatus === "unavailable") {
            const opacityClass = isCurrentMonth ? "" : "opacity-30";
            dinnerDiv.innerHTML = `<div class="w-6 h-6 ${opacityClass}">${createIconBadgeHtml(
              "unavailable"
            )}</div>`;
          }
          gridContainer.appendChild(dinnerDiv);

          cell.appendChild(gridContainer);
          grid.appendChild(cell);
        }
      }

      function fetchMonthlyData() {
        // Fetch data for current view range (approx 5 weeks)
        const year = currentViewDate.getFullYear();
        const month = currentViewDate.getMonth();
        const firstDayOfMonth = new Date(year, month, 1);

        let startDay = firstDayOfMonth.getDay() - 1;
        if (startDay === -1) startDay = 6;

        const startDate = new Date(firstDayOfMonth);
        startDate.setDate(startDate.getDate() - startDay);

        const endDate = new Date(startDate);
        endDate.setDate(endDate.getDate() + 35); // 5 weeks

        const startStr = formatDateISO(startDate);
        const endStr = formatDateISO(endDate);

        document.getElementById("loader").classList.remove("hidden");

        if (IS_LOCAL) {
          setTimeout(() => {
            const stored = localStorage.getItem(`shifts_${currentUser}`);
            if (stored) {
              const parsed = JSON.parse(stored);
              Object.assign(availabilityData, parsed);
            }
            renderMonthlyView();
            document.getElementById("loader").classList.add("hidden");
          }, 300);
        } else {
          // Supabase Monthly Data
          supabase
            .from("shifts")
            .select("*")
            .eq("username", currentUser)
            .gte("date", startStr)
            .lte("date", endStr)
            .then(({ data, error }) => {
              if (error) {
                handleError(error);
              } else {
                data.forEach((item) => {
                  availabilityData[`${item.date}_${item.type}`] = item.status;
                });
                renderMonthlyView();
                document.getElementById("loader").classList.add("hidden");
              }
            });
        }
      }

      function renderAdminTable(users, shifts) {
        const tbody = document.getElementById("admin-tbody");
        tbody.innerHTML = "";

        const map = {};
        shifts.forEach((s) => {
          if (!map[s.name]) map[s.name] = {};
          map[s.name][`${s.date}_${s.type}`] = s.status;
        });

        const startOfWeek = new Date(currentViewDate);

        users.forEach((user, index) => {
          const tr = document.createElement("tr");
          // Background: Always White
          tr.className = "bg-white";

          const nameTd = document.createElement("td");
          nameTd.className =
            "px-2 md:px-4 py-4 whitespace-normal break-words text-xs md:text-lg font-bold text-gray-900 sticky-left-col border-r border-b-2 border-[#333333] w-16 md:w-32 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)]";
          // Sticky column background: Always White
          nameTd.style.backgroundColor = "white";
          nameTd.title = user;
          nameTd.innerText = user;
          tr.appendChild(nameTd);

          const daysTd = document.createElement("td");
          daysTd.colSpan = 7;
          daysTd.className = "p-0 border-b-2 border-[#333333]"; // Thicker/Darker row separator

          const gridDiv = document.createElement("div");
          // Keep vertical dividers light
          gridDiv.className =
            "grid grid-cols-7 divide-x divide-[#E0E0E0] w-full";

          for (let i = 0; i < 7; i++) {
            const d = new Date(startOfWeek);
            d.setDate(d.getDate() + i);
            const dateStr = formatDateISO(d);

            const cell = document.createElement("div");
            // Flex column, no fixed height. Content determines height.
            cell.className = "flex flex-col w-full";

            const lunch =
              (map[user] && map[user][`${dateStr}_lunch`]) || "none";
            const dinner =
              (map[user] && map[user][`${dateStr}_dinner`]) || "none";

            // Lunch Slot
            const lunchWrapper = document.createElement("div");
            lunchWrapper.className =
              "w-full flex justify-center border-b border-[#E0E0E0]"; // Separator spans full width
            const lunchDiv = document.createElement("div");
            // Full width, aspect square
            lunchDiv.className =
              "w-full aspect-square flex items-center justify-center";
            lunchDiv.appendChild(createIconBadge(lunch));
            lunchWrapper.appendChild(lunchDiv);

            // Dinner Slot
            const dinnerWrapper = document.createElement("div");
            dinnerWrapper.className = "w-full flex justify-center";
            const dinnerDiv = document.createElement("div");
            dinnerDiv.className =
              "w-full aspect-square flex items-center justify-center";
            dinnerDiv.appendChild(createIconBadge(dinner));
            dinnerWrapper.appendChild(dinnerDiv);

            cell.appendChild(lunchWrapper);
            cell.appendChild(dinnerWrapper);

            gridDiv.appendChild(cell);
          }

          daysTd.appendChild(gridDiv);
          tr.appendChild(daysTd);
          tbody.appendChild(tr);
        });
      }

      function createIconBadge(status) {
        const div = document.createElement("div");
        div.className = "w-full h-full flex items-center justify-center";
        div.innerHTML = createIconBadgeHtml(status);
        return div;
      }

      function createIconBadgeHtml(status) {
        if (status === "unavailable") {
          // Unavailable: No Background, Brighter Green X Icon (#4ADE80), Responsive
          return `<svg class="w-full h-full p-1 text-[#4ADE80]" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="3">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
          </svg>`;
        } else {
          // Available (Default): Empty
          return "";
        }
      }

      // --- Staff Management Logic ---
      function fetchStaffList() {
        if (IS_LOCAL) {
          const localUsers = JSON.parse(
            localStorage.getItem("local_users") || "{}"
          );
          const localMeta = JSON.parse(
            localStorage.getItem("local_users_meta") || "{}"
          );

          const users = [];
          Object.keys(localUsers).forEach((name) => {
            if (name === "Cathy") return;
            users.push({
              name: name,
              type: (localMeta[name] && localMeta[name].type) || "Casual",
              order: (localMeta[name] && localMeta[name].order) || 999,
            });
          });
          users.sort((a, b) => a.order - b.order);
          renderStaffList(users);
        } else {
          // Supabase Fetch Staff List
          supabase
            .from("app_users")
            .select("*")
            .neq("username", "Cathy")
            .then(({ data, error }) => {
              if (error) {
                handleError(error);
              } else {
                const users = data
                  .map((u) => ({
                    name: u.username,
                    type: u.type,
                    order: u.order_index,
                  }))
                  .sort((a, b) => (a.order || 999) - (b.order || 999));
                renderStaffList(users);
              }
            });
        }
      }

      function renderStaffList(users) {
        const tbody = document.getElementById("staff-list-tbody");
        tbody.innerHTML = "";

        users.forEach((user) => {
          const tr = document.createElement("tr");
          tr.dataset.username = user.name;
          tr.className =
            "hover:bg-gray-50 group border-b border-gray-100 last:border-0";

          // Drag Handle
          const tdMove = document.createElement("td");
          tdMove.className =
            "pl-4 pr-2 py-3 whitespace-nowrap cursor-grab drag-handle w-10 text-center align-middle";
          tdMove.innerHTML = `
                <svg class="w-5 h-5 text-gray-300 group-hover:text-gray-500 transition-colors" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8h16M4 16h16"></path>
                </svg>
            `;
          tr.appendChild(tdMove);

          // Name
          const tdName = document.createElement("td");
          tdName.className =
            "px-2 py-3 whitespace-nowrap text-sm font-medium text-gray-900 w-auto min-w-[100px]";
          tdName.innerText = user.name;
          tr.appendChild(tdName);

          // Type Dropdown
          const tdType = document.createElement("td");
          tdType.className =
            "px-2 py-3 whitespace-nowrap text-sm text-gray-500 w-full";
          const select = document.createElement("select");
          select.className =
            "block w-full py-2 px-3 border border-gray-200 bg-gray-50 rounded-lg text-sm focus:ring-blue-500 focus:border-blue-500 transition-colors cursor-pointer hover:bg-gray-100 text-gray-700";

          const options = [
            { val: "Full-time", label: "Full-time" },
            { val: "Part-time", label: "Part-time" },
            { val: "Casual", label: "Casual" },
          ];

          options.forEach((opt) => {
            const option = document.createElement("option");
            option.value = opt.val;
            option.innerText = opt.label;
            if (user.type === opt.val) option.selected = true;
            select.appendChild(option);
          });

          select.onchange = (e) => updateUserType(user.name, e.target.value);
          tdType.appendChild(select);
          tr.appendChild(tdType);

          // Action (Delete)
          const tdAction = document.createElement("td");
          tdAction.className =
            "px-4 py-3 whitespace-nowrap text-sm text-gray-500 w-12 text-center";
          const btnDelete = document.createElement("button");
          btnDelete.className =
            "text-gray-400 hover:text-red-500 transition-colors p-2 rounded-full hover:bg-red-50 group-hover:text-gray-500";
          btnDelete.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
          `;
          btnDelete.title = "Delete";
          btnDelete.onclick = () => confirmDeleteUser(user.name);
          tdAction.appendChild(btnDelete);
          tr.appendChild(tdAction);

          tbody.appendChild(tr);
        });

        // Initialize Sortable if not already
        if (!window.staffSortable) {
          window.staffSortable = new Sortable(tbody, {
            animation: 150,
            handle: ".drag-handle",
            ghostClass: "bg-blue-50",
            onEnd: function (evt) {
              const rows = tbody.querySelectorAll("tr");
              const newOrder = Array.from(rows).map((r) => r.dataset.username);
              updateStaffOrder(newOrder);
            },
          });
        }
      }

      function updateUserType(name, newType) {
        if (IS_LOCAL) {
          const meta = JSON.parse(
            localStorage.getItem("local_users_meta") || "{}"
          );
          if (!meta[name]) meta[name] = {};
          meta[name].type = newType;
          localStorage.setItem("local_users_meta", JSON.stringify(meta));
          showToast(`Updated ${name} to ${newType}`);
        } else {
          // Supabase Update Type
          supabase
            .from("app_users")
            .update({ type: newType })
            .eq("username", name)
            .then(({ error }) => {
              if (error) handleError(error);
              else showToast(`Updated ${name} to ${newType}`);
            });
        }
      }

      function updateStaffOrder(orderList) {
        if (IS_LOCAL) {
          const meta = JSON.parse(
            localStorage.getItem("local_users_meta") || "{}"
          );
          orderList.forEach((name, idx) => {
            if (!meta[name]) meta[name] = {};
            meta[name].order = idx;
          });
          localStorage.setItem("local_users_meta", JSON.stringify(meta));
          // showToast("Order updated");
        } else {
          // Supabase Update Order (Loop for MVP simplicity)
          // Ideally use RPC or single query, but loop is fine for < 50 users
          const promises = orderList.map((name, idx) =>
            supabase
              .from("app_users")
              .update({ order_index: idx })
              .eq("username", name)
          );
          Promise.all(promises).catch(handleError);
        }
      }

      function confirmDeleteUser(name) {
        // Immediate delete without confirmation
        if (IS_LOCAL) {
          const users = JSON.parse(localStorage.getItem("local_users") || "{}");
          delete users[name];
          localStorage.setItem("local_users", JSON.stringify(users));
          fetchStaffList();
          showToast("User deleted");
        } else {
          // Supabase Delete
          supabase
            .from("app_users")
            .delete()
            .eq("username", name)
            .then(({ error }) => {
              if (error) {
                handleError(error);
              } else {
                fetchStaffList();
                showToast("User deleted");
              }
            });
        }
      }

      // --- Personal View Logic ---
      function getMonday(d) {
        d = new Date(d);
        const day = d.getDay();
        const diff = d.getDate() - day + (day == 0 ? -6 : 1);
        return new Date(d.setDate(diff));
      }

      function changeWeek(offset) {
        const newDate = new Date(currentViewDate);
        newDate.setDate(newDate.getDate() + offset * 7);

        // Define Navigation Boundaries (Common for Admin & Staff)
        // 1. Min Date: Current Week's Monday (Disable Previous button if trying to go before this)
        const currentWeekMonday = getMonday(today);

        // 2. Max Date: Next Week + 8 Weeks
        const nextWeekMonday = new Date(currentWeekMonday);
        nextWeekMonday.setDate(nextWeekMonday.getDate() + 7);

        const maxDate = new Date(nextWeekMonday);
        maxDate.setDate(maxDate.getDate() + 8 * 7); // 8 weeks from next week

        // Check Max Limit
        if (newDate > maxDate) {
          showToast("Max 8 weeks from next week.");
          return;
        }

        // Strict Limit Implementation:
        if (newDate < currentWeekMonday) {
          // But prompt says "Previous week schedule is viewable".
          // So I MUST allow going back.
          // Maybe "Disabled for periods BEFORE the current week" means "Don't go back further than previous week"?
          // Let's set Min Date = Previous Week Monday.
          const prevWeekMonday = new Date(currentWeekMonday);
          prevWeekMonday.setDate(prevWeekMonday.getDate() - 7);

          if (newDate < prevWeekMonday) {
            showToast("Cannot view schedules older than last week.");
            return;
          }
        }

        currentViewDate = newDate;
        if (currentRole === "admin" && currentTab === "team") {
          // Admin Team View Logic
          if (currentTeamSubTab === "dashboard") {
            renderAdminView();
            fetchAdminData();
          }
        } else {
          renderWeek();
          fetchData();
        }
        updateNavigationState();
      }

      function changeMonth(offset) {
        const newDate = new Date(currentViewDate);
        newDate.setMonth(newDate.getMonth() + offset);
        newDate.setDate(1); // Set to 1st of the new month

        // Monthly Limits: Current Month, Next Month, Next Next Month (Total 3)
        const minDate = new Date(today.getFullYear(), today.getMonth(), 1);
        const maxDate = new Date(today.getFullYear(), today.getMonth() + 2, 1); // Current + 2 months

        if (newDate < minDate) {
          showToast("Cannot view past months.");
          return;
        }
        if (newDate > maxDate) {
          showToast("Max 3 months range.");
          return;
        }

        currentViewDate = newDate;
        renderMonthlyView();
        fetchMonthlyData();
        updateNavigationState();
      }

      function updateNavigationState() {
        // Weekly Limits
        const currentWeekMonday = getMonday(today);
        const prevWeekMonday = new Date(currentWeekMonday);
        prevWeekMonday.setDate(prevWeekMonday.getDate() - 7); // Allow 1 week back

        const nextWeekMonday = new Date(currentWeekMonday);
        nextWeekMonday.setDate(nextWeekMonday.getDate() + 7);
        const maxWeekDate = new Date(nextWeekMonday);
        maxWeekDate.setDate(maxWeekDate.getDate() + 8 * 7);

        const btnWeekPrev = document.querySelector(
          "#week-controls button:first-child"
        );
        const btnWeekNext = document.querySelector(
          "#week-controls button:last-child"
        );

        // Calculate Target Dates
        const targetPrevWeek = new Date(currentViewDate);
        targetPrevWeek.setDate(targetPrevWeek.getDate() - 7);

        const targetNextWeek = new Date(currentViewDate);
        targetNextWeek.setDate(targetNextWeek.getDate() + 7);

        if (btnWeekPrev) {
          // Disable if target is older than "Previous Week"
          if (targetPrevWeek < prevWeekMonday) {
            btnWeekPrev.classList.add(
              "opacity-30",
              "cursor-not-allowed",
              "pointer-events-none"
            );
            // Also disable the SVG inside to be sure? CSS handles pointer-events-none
          } else {
            btnWeekPrev.classList.remove(
              "opacity-30",
              "cursor-not-allowed",
              "pointer-events-none"
            );
          }
        }

        if (btnWeekNext) {
          if (targetNextWeek > maxWeekDate) {
            btnWeekNext.classList.add(
              "opacity-30",
              "cursor-not-allowed",
              "pointer-events-none"
            );
          } else {
            btnWeekNext.classList.remove(
              "opacity-30",
              "cursor-not-allowed",
              "pointer-events-none"
            );
          }
        }

        // Monthly Limits
        const minMonthDate = new Date(today.getFullYear(), today.getMonth(), 1);
        const maxMonthDate = new Date(
          today.getFullYear(),
          today.getMonth() + 2,
          1
        );

        const targetPrevMonth = new Date(currentViewDate);
        targetPrevMonth.setMonth(targetPrevMonth.getMonth() - 1);
        targetPrevMonth.setDate(1);

        const targetNextMonth = new Date(currentViewDate);
        targetNextMonth.setMonth(targetNextMonth.getMonth() + 1);
        targetNextMonth.setDate(1);

        const monthlyControls = document.querySelectorAll(
          "#monthly-view button"
        );
        if (monthlyControls.length >= 2) {
          const btnMonthPrev = monthlyControls[0];
          const btnMonthNext = monthlyControls[1];

          if (targetPrevMonth < minMonthDate) {
            btnMonthPrev.classList.add(
              "opacity-30",
              "cursor-not-allowed",
              "pointer-events-none"
            );
          } else {
            btnMonthPrev.classList.remove(
              "opacity-30",
              "cursor-not-allowed",
              "pointer-events-none"
            );
          }

          if (targetNextMonth > maxMonthDate) {
            btnMonthNext.classList.add(
              "opacity-30",
              "cursor-not-allowed",
              "pointer-events-none"
            );
          } else {
            btnMonthNext.classList.remove(
              "opacity-30",
              "cursor-not-allowed",
              "pointer-events-none"
            );
          }
        }
      }

      function renderWeek() {
        const grid = document.getElementById("schedule-grid");
        grid.innerHTML = "";

        // Thursday Banner Logic (Global Alert on Thursday)
        // Only show if today is Thursday AND not dismissed in this session

        // Remove existing banner if present to prevent duplicates
        const existingBanner = document.getElementById("thursday-banner");
        if (existingBanner) existingBanner.remove();

        if (
          today.getDay() === 4 &&
          !sessionStorage.getItem("thursday_banner_dismissed")
        ) {
          // 4 = Thursday
          const banner = document.createElement("div");
          banner.id = "thursday-banner";
          // Fixed at top, full width, high z-index, readable styling
          // Using sticky to push content down instead of overlaying
          banner.className =
            "sticky top-0 left-0 w-full z-[2000] bg-blue-600 text-white shadow-xl";
          banner.innerHTML = `
             <div class="max-w-7xl mx-auto px-4 py-3 flex items-center justify-between sm:px-6 lg:px-8">
               <div class="flex items-center flex-1 w-0">
                 <span class="flex p-2 bg-blue-800 rounded-lg">
                   <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                   </svg>
                 </span>
                 <p class="ml-3 font-medium text-white break-words whitespace-normal text-sm md:text-base">
                   <span class="md:hidden">Next week's schedule locks at 6pm</span>
                   <span class="hidden md:inline">Next week's shift schedule will be locked today at 6pm</span>
                 </p>
               </div>
               <div class="flex-shrink-0 sm:ml-3">
                 <button type="button" onclick="sessionStorage.setItem('thursday_banner_dismissed', 'true'); this.closest('.sticky').remove()" class="-mr-1 flex p-2 rounded-md hover:bg-blue-500 focus:outline-none sm:-mr-2 transition ease-in-out duration-150">
                   <span class="sr-only">Dismiss</span>
                   <svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                     <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                   </svg>
                 </button>
               </div>
             </div>
           `;
          // Prepend to body to push content down
          document.body.insertBefore(banner, document.body.firstChild);
        }

        const startOfWeek = new Date(currentViewDate);
        const endOfWeek = new Date(currentViewDate);
        endOfWeek.setDate(endOfWeek.getDate() + 6);

        // Next Week Guidance Banner
        const currentWeekStart = getMonday(today);
        const nextWeekStart = new Date(currentWeekStart);
        nextWeekStart.setDate(nextWeekStart.getDate() + 7);

        if (
          startOfWeek.getTime() === nextWeekStart.getTime() &&
          currentRole !== "admin"
        ) {
          const deadline = new Date(currentWeekStart);
          deadline.setDate(deadline.getDate() + 3); // Thursday
          deadline.setHours(18, 0, 0, 0);

          const isLocked = today > deadline;

          const infoBanner = document.createElement("div");
          infoBanner.className = `mb-4 p-3 rounded-lg border flex items-center gap-3 ${
            isLocked
              ? "bg-red-50 border-red-200 text-red-700"
              : "bg-blue-50 border-blue-200 text-blue-700"
          }`;
          infoBanner.innerHTML = `
                <svg class="w-5 h-5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div class="text-sm font-medium">
                    ${
                      isLocked
                        ? "Editing for next week is closed (Deadline: Last Thursday 6:00 PM)."
                        : "You can edit this schedule until this Thursday at 6:00 PM."
                    }
                </div>
             `;
          grid.appendChild(infoBanner);
        }

        document.getElementById("week-range").innerText = `${formatDateShort(
          startOfWeek
        )} ~ ${formatDateShort(endOfWeek)}`;

        const isReadOnly = checkReadOnly(startOfWeek);

        const statusEl = document.getElementById("week-status");
        if (isReadOnly) {
          statusEl.innerText = " Locked (Read-only)";
          statusEl.className = "text-xs text-red-500 font-medium";
        } else {
          statusEl.innerText = " Editable";
          statusEl.className = "text-xs text-green-600 font-medium";
        }

        for (let i = 0; i < 7; i++) {
          const d = new Date(startOfWeek);
          d.setDate(d.getDate() + i);
          const dateStr = formatDateISO(d);
          const dayName = DAYS_EN[d.getDay()];
          const isToday = formatDateISO(d) === formatDateISO(today);

          const card = document.createElement("div");
          // Single Column Layout (List View)
          card.className = `bg-white p-4 rounded-xl shadow-sm border flex flex-col sm:flex-row sm:items-center justify-between gap-4 transition-colors duration-200 w-full max-w-full ${
            isToday
              ? "border-blue-500 ring-1 ring-blue-500"
              : "border-gray-100 hover:border-gray-300"
          }`;

          const lunchStatus = availabilityData[`${dateStr}_lunch`] || "none";
          const dinnerStatus = availabilityData[`${dateStr}_dinner`] || "none";

          // Access Control Logic
          const minDate = new Date(today.getFullYear(), today.getMonth(), 1);
          const currentWeekStart = getMonday(today);
          const nextWeekStart = new Date(currentWeekStart);
          nextWeekStart.setDate(nextWeekStart.getDate() + 7);

          if (currentRole !== "admin") {
            if (d < minDate) {
              // Past Data Hidden
              card.innerHTML = `
                      <div class="flex items-center justify-between sm:justify-start gap-4 min-w-[120px]">
                            <div class="flex flex-col opacity-50">
                                <span class="font-bold text-lg text-gray-400">
                                    ${d.getDate()} <span class="text-sm font-normal text-gray-400 ml-1">${dayName}</span>
                                </span>
                            </div>
                        </div>
                        <div class="flex gap-3 w-full sm:w-auto flex-1 max-w-md items-center justify-center text-sm text-gray-400 italic">
                            Past data hidden
                        </div>
                  `;
            } else if (d < nextWeekStart && isReadOnly) {
              // Current Week (or Locked): Read Only
              card.innerHTML = `
                    <div class="flex items-center justify-between sm:justify-start gap-4 min-w-[120px]">
                        <div class="flex flex-col">
                            <span class="font-bold text-lg text-gray-600">
                                ${d.getDate()} <span class="text-sm font-normal text-gray-500 ml-1">${dayName}</span>
                            </span>
                        </div>
                        ${
                          isToday
                            ? '<span class="text-sm font-bold bg-blue-600 text-white px-3 py-1 rounded-full shadow-md">Today</span>'
                            : ""
                        }
                    </div>
                    <div class="flex gap-3 w-full flex-1">
                        ${createButton(
                          dateStr,
                          "lunch",
                          "Lunch",
                          lunchStatus,
                          true
                        )}
                        ${createButton(
                          dateStr,
                          "dinner",
                          "Dinner",
                          dinnerStatus,
                          true
                        )}
                    </div>
                  `;
            } else {
              // Next Week+: Editable (Standard)
              card.innerHTML = generateStandardCardHtml(
                d,
                dayName,
                isToday,
                dateStr,
                lunchStatus,
                dinnerStatus,
                isReadOnly
              );
            }
          } else {
            // Admin: Always Standard
            card.innerHTML = generateStandardCardHtml(
              d,
              dayName,
              isToday,
              dateStr,
              lunchStatus,
              dinnerStatus,
              isReadOnly
            );
          }

          grid.appendChild(card);
        }
      }

      function generateStandardCardHtml(
        d,
        dayName,
        isToday,
        dateStr,
        lunchStatus,
        dinnerStatus,
        isReadOnly
      ) {
        return `
            <div class="flex items-center justify-between sm:justify-start gap-4 min-w-[120px]">
                <div class="flex flex-col">
                    <span class="font-bold text-lg ${
                      d.getDay() === 0
                        ? "text-red-500"
                        : d.getDay() === 6
                        ? "text-blue-500"
                        : "text-gray-800"
                    }">
                        ${d.getDate()} <span class="text-sm font-normal text-gray-500 ml-1">${dayName}</span>
                    </span>
                </div>
                ${
                  isToday
                    ? '<span class="text-sm font-bold bg-blue-600 text-white px-3 py-1 rounded-full shadow-md">Today</span>'
                    : ""
                }
            </div>
            <div class="flex gap-3 w-full flex-1">
                ${createButton(
                  dateStr,
                  "lunch",
                  "Lunch",
                  lunchStatus,
                  isReadOnly
                )}
                ${createButton(
                  dateStr,
                  "dinner",
                  "Dinner",
                  dinnerStatus,
                  isReadOnly
                )}
            </div>
        `;
      }

      function createButton(date, type, label, status, isReadOnly) {
        // Modern Rectangular Button
        let baseClass =
          "relative flex-1 h-12 rounded-lg transition-all duration-200 flex items-center justify-center border border-gray-200 text-sm font-medium";
        let content = "";

        if (status === "unavailable") {
          baseClass += " bg-white border-green-500 shadow-sm text-gray-400";
          content = `
                <div class="flex items-center gap-2">
                    <span>${label}</span>
                    <svg class="w-5 h-5 text-green-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" stroke-width="2.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </div>
            `;
        } else {
          baseClass +=
            " bg-white hover:bg-gray-50 hover:shadow-md hover:border-gray-300 text-gray-600";
          content = `<span>${label}</span>`;
        }

        if (isReadOnly) {
          return `
            <div class="${baseClass} opacity-50 cursor-not-allowed bg-gray-50">
                ${content}
            </div>
          `;
        } else {
          return `
            <button onclick="toggleStatus('${date}', '${type}')" class="${baseClass} focus:outline-none focus:ring-2 focus:ring-green-500 focus:ring-opacity-50 active:scale-95">
                ${content}
            </button>
          `;
        }
      }

      function checkReadOnly(weekStart) {
        // 1. Current Week (or Past): Read-Only / Locked
        const currentWeekStart = getMonday(today);

        // Past Weeks are strictly Read-Only
        if (weekStart < currentWeekStart) return true;

        // Current & Future Weeks: Check DB Lock Flag
        const weekStr = formatDateISO(weekStart);
        if (lockedWeeks.has(weekStr)) {
          return true;
        }

        // 3. Thursday Deadline Logic (Only for Next Week, if not explicitly locked)
        const nextWeekStart = new Date(currentWeekStart);
        nextWeekStart.setDate(nextWeekStart.getDate() + 7);

        if (weekStart.getTime() === nextWeekStart.getTime()) {
          const deadline = new Date(currentWeekStart);
          deadline.setDate(deadline.getDate() + 3); // Thursday
          deadline.setHours(18, 0, 0, 0); // 18:00 (6 PM)

          if (today > deadline) return true;
        }

        return false;
      }

      function toggleStatus(date, type) {
        // Validation: Double check (UI should have prevented this, but for safety)
        const d = new Date(date);
        // Get Week Start for this date
        const day = d.getDay();
        const diff = d.getDate() - day + (day == 0 ? -6 : 1);
        const monday = new Date(d.setDate(diff));

        if (checkReadOnly(monday)) {
          showToast("This week is locked and cannot be edited.");
          return;
        }

        const key = `${date}_${type}`;
        const current = availabilityData[key] || "none";
        // One-click toggle: If currently unavailable -> available (none/empty), else -> unavailable
        let next;
        if (current === "unavailable") {
          next = "available"; // Or "none" depending on backend logic, treating "available" as default
        } else {
          next = "unavailable";
        }

        availabilityData[key] = next;
        renderWeek();

        // Add to unsaved changes
        unsavedChanges.add(key);
        updateSaveBar();
      }

      function updateSaveBar() {
        const bar = document.getElementById("save-bar");
        const msg = bar.querySelector("span");
        msg.innerText = "You have unsaved changes.";

        if (unsavedChanges.size > 0) {
          bar.classList.remove("hidden");
        } else {
          bar.classList.add("hidden");
        }
      }

      function fetchData() {
        const start = formatDateISO(currentViewDate);
        const end = new Date(currentViewDate);
        end.setDate(end.getDate() + 6);
        const endStr = formatDateISO(end);

        document.getElementById("loader").classList.remove("hidden");

        if (IS_LOCAL) {
          setTimeout(() => {
            const stored = localStorage.getItem(`shifts_${currentUser}`);
            if (stored) {
              const parsed = JSON.parse(stored);
              Object.assign(availabilityData, parsed);
            }
            renderWeek();
            document.getElementById("loader").classList.add("hidden");
          }, 300);
        } else {
          // Supabase Fetch Personal Data
          supabase
            .from("shifts")
            .select("*")
            .eq("username", currentUser)
            .gte("date", start)
            .lte("date", endStr)
            .then(({ data, error }) => {
              if (error) {
                handleError(error);
              } else {
                data.forEach((item) => {
                  availabilityData[`${item.date}_${item.type}`] = item.status;
                });
                renderWeek();
                document.getElementById("loader").classList.add("hidden");
              }
            });
        }
      }

      function saveChanges() {
        if (unsavedChanges.size === 0) return;

        showToast("Saving...");

        const toSend = [];
        unsavedChanges.forEach((key) => {
          const [date, type] = key.split("_");
          toSend.push({ date, type, status: availabilityData[key] });
        });

        if (IS_LOCAL) {
          // Local Save
          const stored = localStorage.getItem(`shifts_${currentUser}`) || "{}";
          const parsed = JSON.parse(stored);

          toSend.forEach((item) => {
            parsed[`${item.date}_${item.type}`] = item.status;
          });

          localStorage.setItem(`shifts_${currentUser}`, JSON.stringify(parsed));

          setTimeout(() => {
            saveSuccess();
          }, 500);
        } else {
          // Supabase Save (Upsert)
          const upsertData = toSend.map((item) => ({
            username: currentUser,
            date: item.date,
            type: item.type,
            status: item.status,
          }));

          supabase
            .from("shifts")
            .upsert(upsertData, { onConflict: "username, date, type" })
            .then(({ error }) => {
              if (error) {
                handleError(error);
              } else {
                saveSuccess();
              }
            });
        }
      }

      function saveSuccess() {
        showToast("Saved successfully");
        unsavedChanges.clear();
        updateSaveBar();
      }

      // --- Utils ---
      function formatDateISO(d) {
        const y = d.getFullYear();
        const m = ("0" + (d.getMonth() + 1)).slice(-2);
        const day = ("0" + d.getDate()).slice(-2);
        return `${y}-${m}-${day}`;
      }

      function formatDateShort(d) {
        return `${d.getMonth() + 1}/${d.getDate()}`;
      }

      function showToast(msg) {
        const el = document.getElementById("status-bar");
        el.innerText = msg;
        setTimeout(() => {
          if (el.innerText === msg) el.innerText = "Ready";
        }, 3000);
      }

      function handleError(e) {
        console.error(e);
        showToast("Error: " + e.message);
        if (document.getElementById("loader"))
          document.getElementById("loader").classList.add("hidden");
        if (document.getElementById("admin-loader"))
          document.getElementById("admin-loader").classList.add("hidden");
      }
    </script>
  </body>
</html>
